local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")

local PlaceId = game.PlaceId
local LocalPlayer = Players.LocalPlayer

local WEBHOOK_URL = "DISCORD_WEBHOOK_URL" -- ganti pake webhook lu
local TeleportData = {}
local Cursor = ""
local MAX_PLAYER = 15 -- maksimal jumlah player di server

-- function kirim webhook
local function sendWebhook(msg)
    if not req then
        warn("Request function tidak tersedia di executor kamu.")
        return false
    end

    local jobId = game.JobId
    local gameLink = "roblox://placeId=" .. PLACE_ID .. "&gameInstanceId=" .. jobId
    local body = {
        content = "☄️ Meteor Shower Found!\n" .. playerCount .. "/20\n" .. gameLink,
        components = {
            {
                type = 1,
                components = {
                    {
                        type = 2,
                        label = "Join Game",
                        style = 5,
                        url = gameLink
                    }
                }
            }
        }
    }

    -- Add error handling for webhook request
    local success, response = pcall(function()
        return req({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(body)
        })
    end)

    if success then
        print("✅ Webhook sent successfully!")
        if response and response.StatusCode then
            print("Status Code:", response.StatusCode)
        end
        return true
    else
        warn("❌ Webhook failed:", tostring(response))
        return false
    end
end

-- serverhop function
local function serverHop()
    local url = "https://games.roblox.com/v1/games/" .. PlaceId .. "/servers/Public?sortOrder=Desc&limit=100"

    if Cursor ~= "" then
        url = url .. "&cursor=" .. Cursor
    end

    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)

    if success and result and result.data then
        local validServers = {}

        for _, server in ipairs(result.data) do
            -- skip server yg full, terlalu rame (> MAX_PLAYER), atau udah dikunjungi
            if server.playing < server.maxPlayers
               and server.playing <= MAX_PLAYER
               and not TeleportData[server.id]
               and server.id ~= game.JobId then
                table.insert(validServers, server)
            end
        end

        if #validServers > 0 then
            local pick = validServers[math.random(1, #validServers)]
            TeleportData[pick.id] = true
            TeleportService:TeleportToPlaceInstance(PlaceId, pick.id, LocalPlayer)
        elseif result.nextPageCursor then
            Cursor = result.nextPageCursor
            serverHop()
        else
            if result.nextPageCursor then
                Cursor = result.nextPageCursor
                serverHop()
            else
                warn("Tidak ada server yang cocok.")
            end
            warn("Tidak ada server yang cocok.")
        end
    else
        warn("Gagal ambil data server.")
    end
end

serverHop()
-- cek meteor
local function checkMeteor()
    local boosts = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("MainUI"):WaitForChild("Boosts")

    if boosts:FindFirstChild("Meteor Shower") then
        local playerCount = #Players:GetPlayers()
        local link = "https://www.roblox.com/games/"..PlaceId.."?serverId="..game.JobId
        local msg = string.format("Meteor Shower Found\nPlayers: %d\nServer: %s", playerCount, link)
        sendWebhook(msg)

        task.wait(20) -- tunggu 20 detik abis kirim webhook
        serverHop()
    else
        task.wait(30) -- ga ketemu → tunggu 30 detik dulu
        serverHop()
    end
end

-- tunggu 60 detik abis join server baru
task.delay(60, function()
    checkMeteor()
end)
